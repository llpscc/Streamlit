## Итоговый отчет по выполненному заданию

### Этапы работы

1. **Первичный EDA и препроцессинг:**

   * Проведен анализ данных: выявлены пропуски, дубликаты, несоответствия форматов.
   * Большая часть строковых признаков (mileage, engine, max_power, torque) содержала числовые значения с единицами измерения. Были применены регулярные выражения и разбор по шаблонам.
   * Признак `torque` был самым сложным — 27 различных шаблонов. Использована функция на базе регулярных выражений с обработкой исключений. Все значения переведены к Nm и выделены два новых признака: `torque_val` и `max_torque_rpm`.
   * Заполнение пропусков медианами train-выборки позволило избежать утечки данных и сохранить распределения. `seats` и `engine` приведены к `int`, так как значения дискретны.

   **Вывод:**
   На этом этапе основное внимание уделялось качественной обработке данных, чтобы заложить фундамент для дальнейшего обучения.

2. **Анализ признаков и визуализация:**

   * `pairplot` показал линейную и монотонную зависимость между `selling_price` и признаками `year`, `km_driven`, `engine`, `max_power`.
   * Корреляция Пирсона подтвердила эти зависимости. Наименьшая корреляция — между `engine` и `year`, сильнейшая — `max_power` и `selling_price`.
   * Построена и протестирована собственная реализация Спирмена. Отличие от библиотечной минимальное, подтверждает корректность кода.
   * Применение PhiK позволило учесть категориальные признаки. Хотя в одиночку phik показывает не очень хорошие результаты на числовых признаков, построение комбинированной тепловой карты Spearman+PhiK дало полную картину. 
   * `boxplot` визуализировали влияние категориальных переменных: `fuel`, `owner`, `transmission`, `seller_type` на целевую переменную .

   **Вывод:**
   Подтверждена важность как числовых, так и категориальных признаков. Особенно выделяются `owner` и `transmission`, где различия между группами значительны. Это оправдало последующее one-hot-кодирование. ННаименее скоррелированными между собой оказались признаки **engine** и **year**. Среди категориальных признаков **Transmission** значительно коррелирует с такими признаками, как **max_power**, **engine**, **selling_price**. Рассматривая коэффициенты корреляции признака **owner** можно выделить относительно высокую зависимость от признаков **year** и **selling_price**

### Обучение моделей

#### Часть 2: Линейные модели (только числовые признаки)

```text
| Model                           | R2 train | R2 test | MSE train        | MSE test         |
|--------------------------------|----------|---------|------------------|------------------|
| Linear Regression              | 0.601684889360586   | 0.601684889360586 |114172381456.5194         |230106636531.60794        |
| Linear Regression + Scaler    |0.6016848893605868  | 0.5996951886357927  | 114172381456.51913        | 230106636531.60718        |
| Lasso                          | 0.6016848893154992   |0.5996939340336028  | 114172381469.44296       |230107357712.77194        |
| Lasso + Grid Search           | 0.593298803152317  | 0.5715737852888855  |  116576155272.5836         | 246271622200.036    |
| Elastic Net                   | 0.5934004375903901   | 0.5717697501682384 | 116547022946.13437         | 246158975991.48175         |
```

**Вывод:**
Отличия метрик при использовании разных вариаций минимальные. Напрашивается вывод, что использование только числовых признаков ограничивает потенциал модели. Регуляризация L1/L2/L0 не улучшила качество, а так же не занулила никакие веса. Можно сделать вывод, что все числовые признаки оказались значимыми. `max_power`оказался наиболее информативным в предсказании цены.

#### Часть 3: Добавление категориальных признаков и обучение модели Ridge

В рамках этой части предварительно был обработан признак name. Было принято решение разбить строку на составляющие brand, model, configuration, а так же удалить из названий типы топлива, которые дублируют основную колонку fuel. Так же были закодированы категориальные признаки.

```text
| Model                                      | R2 train | R2 test | MSE train    | MSE test     |
|-------------------------------------------|----------|---------|--------------|--------------|
| Linear Regression + Scaler  | 0.9727551368666625   | 0.9367973928840415  |  7809422297.327911     | 36330663361.05051    |
| Ridge + Scaler +GridSearch | 0.9719572547177254 | 0.9403042346519426  | 8038125910.70466    |34314830572.755337     |
| Ridge + Scaler+ GridSearch + log(y)  |  0.9805887153020343  | 0.9402371950004001  |5564018391.216769   |  34353366878.822006    |
```

**Вывод:**
Ridge оказался оптимальной моделью. GridSearch улучшил метрики на тесте. Логарифмирование целевой переменной дало прирост на трейне, сохранив обобщающую способность. 

### Бизнес-метрики и анализ ошибок

* Реализована бизнесовая метрика — среднее процентное отклонение от истинной цены.
* Ridge без логарифма: **27%**, с логарифмом — **24%**.
* Это выше целевого значения в 10%, но демонстрирует высокий потенциал.
* Кастомная метрика (направление ошибки) показала, что модель чаще переоценивает цену.

**Вывод:**
Модель ближе к применению в бизнесе, но требует тонкой настройки: логарифмирование, работа с ценовыми группами, обучение на stratifed выборках. # заключение GPT :)

### Приложение на Streamlit

* Для переноса модели в Streamlit построен полноценный пайплайн:

  * Обработка входных данных.
  * Воспроизведение всех шагов препроцессинга.
  * Применение модели Ridge с логарифмированием.
  * Обратное преобразование целевой переменной.

* Сохранен обработанный датасет для вычисления медианы и применения к входым данным
    
* Визуализации:
  * Перенесена тепловая карта, построенная на комбинации корреляции Спирмана и phik
  * Реализован функционал просмотра зависимостей между различными переменными, с возможностью выбора необходимых наборов и распределений значения категориального признака.
  * Реализована возможность скачать полный Profile Report по ссылке из приложения

**Вывод:**
На мой взгляд, приложение удобно для тестирования модели. Оно позволяет как внести данные по одному автомобилю, так и загрузить более объемный CSV файл. В разделе EDA можно скачать полный отчет, а так же посмотреть зависимости между отдельными признаками. В отдельной вкладке можно посмотреть график или таблицу с весами признаков. Приложение принимает на вход не обработанные данные, самостоятельно их обрабатывает и вычисляет целевую переменную.

### Финальные выводы

* **Что дало наибольший прирост:**

  * Обработка признаков с нестандартным форматом (`torque`, `name`), использование категориальных и числовых признаков совместно.
  * Ridge + GridSearch на всех признаках в комбинации с логарифмированием целевой переменной дали лучший результат.

* **Что не сработало:**

  * Остальные линейные модели без категориальных признаков не показали хороших результатов. Судя по всему, категориальные признаки в датасете так же важны, как и числовые. Не хватило времени и сил попробовать feature engineering :))) Возможно где-то в конце косяк и утечка данных, результат будто подозрительно хороший. Хотя при этом, почему-то, в бизнесовую метрику попасть не удалось, даже при R2 = 94, процент отклонения больше 20.
